"use strict";
/*
 * Copyright (c) 2018 by Filestack.
 * Some rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
// import Debug from 'debug';
var filestack_error_1 = require("./../../filestack_error");
var client_1 = require("./../client");
var request_1 = require("../request");
var utils_1 = require("./../utils");
var PrefetchEvents;
(function (PrefetchEvents) {
    PrefetchEvents["PICKER"] = "picker";
    PrefetchEvents["TRANSFORM_UI"] = "transform_ui";
})(PrefetchEvents = exports.PrefetchEvents || (exports.PrefetchEvents = {}));
/**
 * @private
 */
var Prefetch = /** @class */ (function () {
    function Prefetch(param) {
        if (param instanceof client_1.Client) {
            this.session = param.session;
        }
        else {
            this.session = param;
        }
    }
    /**
     * Returns filestack options from backend according to input params
     *
     * @param param0
     */
    Prefetch.prototype.getConfig = function (_a) {
        var pickerOptions = _a.pickerOptions, settings = _a.settings, permissions = _a.permissions, events = _a.events;
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var paramsToSend, pickerOptionsToSend;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                paramsToSend = {
                    apikey: this.session.apikey,
                };
                if (this.session.policy && this.session.signature) {
                    paramsToSend.security = { policy: this.session.policy, signature: this.session.signature };
                }
                if (this.session.prefetch && events) {
                    return [2 /*return*/, request_1.FsRequest.post(this.session.urls.uploadApiUrl + "/prefetch", tslib_1.__assign(tslib_1.__assign({}, paramsToSend), { events: events })).then(function () { return _this.session.prefetch; })];
                }
                // we should always ask for this setting for picker
                if (!settings) {
                    settings = ['inapp_browser'];
                }
                else {
                    settings = settings.concat(['inapp_browser']);
                    // make arrray unique
                    settings = settings.filter(function (v, i, a) { return settings.indexOf(v) === i; });
                }
                if (pickerOptions && Object.keys(pickerOptions).length) {
                    pickerOptionsToSend = utils_1.cleanUpCallbacks(tslib_1.__assign({}, pickerOptions));
                }
                paramsToSend = tslib_1.__assign(tslib_1.__assign({}, paramsToSend), { permissions: permissions,
                    settings: settings, picker_config: pickerOptionsToSend, events: events });
                this.session.prefetch = null;
                return [2 /*return*/, request_1.FsRequest.post(this.session.urls.uploadApiUrl + "/prefetch", paramsToSend).then(function (res) {
                        /* istanbul ignore if */
                        if (res.status !== 200) {
                            throw new filestack_error_1.FilestackError('There is a problem with prefetch request');
                        }
                        var data = res.data;
                        // if backend not returning updated_config cay we take old config and return
                        if (data.updated_config) {
                            // reassign callback from old config to new one returned from backend
                            data.pickerOptions = _this.reassignCallbacks(pickerOptions, data.updated_config || {});
                            delete data.updated_config;
                        }
                        else {
                            data.pickerOptions = pickerOptions;
                        }
                        _this.session.prefetch = data;
                        return data;
                    })];
            });
        });
    };
    /**
     * Reassign callbacks from old picker configuration
     *
     * @param objOld
     * @param objTarget
     */
    Prefetch.prototype.reassignCallbacks = function (objOld, objTarget) {
        if (!objOld || Object.keys(objOld).length === 0) {
            return objOld;
        }
        for (var k in objOld) {
            if (typeof objOld[k] === 'function') {
                objTarget[k] = objOld[k];
            }
            if (objOld[k] === Object(objOld[k])) {
                objTarget[k] = this.reassignCallbacks(objOld[k], objTarget[k]);
            }
        }
        return objTarget;
    };
    return Prefetch;
}());
exports.Prefetch = Prefetch;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYXBpL3ByZWZldGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7OztBQUVILDZCQUE2QjtBQUM3QiwyREFBeUQ7QUFDekQsc0NBQXdEO0FBRXhELHNDQUF1QztBQUN2QyxvQ0FBOEM7QUFnQjlDLElBQVksY0FHWDtBQUhELFdBQVksY0FBYztJQUN4QixtQ0FBaUIsQ0FBQTtJQUNqQiwrQ0FBNkIsQ0FBQTtBQUMvQixDQUFDLEVBSFcsY0FBYyxHQUFkLHNCQUFjLEtBQWQsc0JBQWMsUUFHekI7QUF5QkQ7O0dBRUc7QUFDSDtJQUlFLGtCQUFZLEtBQXVCO1FBQ2pDLElBQUksS0FBSyxZQUFZLGVBQU0sRUFBRTtZQUMzQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7U0FDOUI7YUFBTTtZQUNMLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1NBQ3RCO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDRyw0QkFBUyxHQUFmLFVBQWdCLEVBQWlFO1lBQS9ELGdDQUFhLEVBQUUsc0JBQVEsRUFBRSw0QkFBVyxFQUFFLGtCQUFNOzs7OztnQkFDeEQsWUFBWSxHQUFvQjtvQkFDbEMsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTTtpQkFDNUIsQ0FBQztnQkFFRixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFO29CQUNqRCxZQUFZLENBQUMsUUFBUSxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO2lCQUM1RjtnQkFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxJQUFJLE1BQU0sRUFBRTtvQkFDbkMsc0JBQU8sbUJBQVMsQ0FBQyxJQUFJLENB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QUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDaEU7U0FDRjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDSCxlQUFDO0FBQUQsQ0FwR0EsQUFvR0MsSUFBQTtBQXBHWSw0QkFBUSIsImZpbGUiOiJsaWIvYXBpL3ByZWZldGNoLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAoYykgMjAxOCBieSBGaWxlc3RhY2suXG4gKiBTb21lIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IEZpbGVzdGFja0Vycm9yIH0gZnJvbSAnLi8uLi8uLi9maWxlc3RhY2tfZXJyb3InO1xuaW1wb3J0IHsgU2Vzc2lvbiwgU2VjdXJpdHksIENsaWVudCB9IGZyb20gJy4vLi4vY2xpZW50JztcbmltcG9ydCB7IFBpY2tlck9wdGlvbnMgfSBmcm9tICcuLy4uL3BpY2tlcic7XG5pbXBvcnQgeyBGc1JlcXVlc3QgfSBmcm9tICcuLi9yZXF1ZXN0JztcbmltcG9ydCB7IGNsZWFuVXBDYWxsYmFja3MgfSBmcm9tICcuLy4uL3V0aWxzJztcblxuLy8gY29uc3QgZGVidWcgPSBEZWJ1ZygnZnM6cHJlZmV0Y2gnKTtcblxuZXhwb3J0IHR5cGUgUHJlZmV0Y2hTZXR0aW5ncyA9IHtcbiAgaW5hcHBfYnJvd3Nlcj86IGJvb2xlYW47XG59O1xuXG5leHBvcnQgdHlwZSBQcmVmZXRjaFBlcm1pc3Npb25zID0ge1xuICBpbnRlbGxpZ2VudF9pbmdlc3Rpb24/OiBib29sZWFuO1xuICB3aGl0ZWxhYmVsPzogYm9vbGVhbjtcbiAgdHJhbnNmb3Jtc191aT86IGJvb2xlYW47XG4gIGVuaGFuY2U/OiBib29sZWFuO1xuICBhZHZhbmNlZF9lbmhhbmNlPzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCBlbnVtIFByZWZldGNoRXZlbnRzIHtcbiAgUElDS0VSID0gJ3BpY2tlcicsXG4gIFRSQU5TRk9STV9VSSA9ICd0cmFuc2Zvcm1fdWknLFxufVxuXG5leHBvcnQgdHlwZSBQcmVmZXRjaE9wdGlvbnMgPSB7XG4gIHBpY2tlck9wdGlvbnM/OiBQaWNrZXJPcHRpb25zO1xuICBzZXR0aW5ncz86IEFycmF5PGtleW9mIFByZWZldGNoU2V0dGluZ3M+O1xuICBwZXJtaXNzaW9ucz86IEFycmF5PGtleW9mIFByZWZldGNoUGVybWlzc2lvbnM+O1xuICBldmVudHM/OiBQcmVmZXRjaEV2ZW50c1tdO1xufTtcblxuaW50ZXJmYWNlIFByZWZldGNoUmVxdWVzdCB7XG4gIGFwaWtleTogc3RyaW5nO1xuICBzZWN1cml0eT86IFNlY3VyaXR5O1xuICBwZXJtaXNzaW9ucz86IEFycmF5PGtleW9mIFByZWZldGNoUGVybWlzc2lvbnM+O1xuICBzZXR0aW5ncz86IEFycmF5PGtleW9mIFByZWZldGNoU2V0dGluZ3M+O1xuICBldmVudHM/OiBQcmVmZXRjaEV2ZW50c1tdO1xuICBwaWNrZXJfY29uZmlnPzogUGlja2VyT3B0aW9ucztcbn1cblxuZXhwb3J0IHR5cGUgUHJlZmV0Y2hSZXNwb25zZSA9IHtcbiAgYmxvY2tlZD86IGJvb2xlYW4gfCBzdHJpbmc7XG4gIHNldHRpbmdzPzogUHJlZmV0Y2hTZXR0aW5ncztcbiAgcGVybWlzc2lvbnM/OiBQcmVmZXRjaFBlcm1pc3Npb25zO1xuICBwaWNrZXJPcHRpb25zOiBQaWNrZXJPcHRpb25zO1xufTtcblxuLyoqXG4gKiBAcHJpdmF0ZVxuICovXG5leHBvcnQgY2xhc3MgUHJlZmV0Y2gge1xuXG4gIHByaXZhdGUgc2Vzc2lvbjogU2Vzc2lvbjtcblxuICBjb25zdHJ1Y3RvcihwYXJhbTogU2Vzc2lvbiB8IENsaWVudCkge1xuICAgIGlmIChwYXJhbSBpbnN0YW5jZW9mIENsaWVudCkge1xuICAgICAgdGhpcy5zZXNzaW9uID0gcGFyYW0uc2Vzc2lvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXNzaW9uID0gcGFyYW07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgZmlsZXN0YWNrIG9wdGlvbnMgZnJvbSBiYWNrZW5kIGFjY29yZGluZyB0byBpbnB1dCBwYXJhbXNcbiAgICpcbiAgICogQHBhcmFtIHBhcmFtMFxuICAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnKHsgcGlja2VyT3B0aW9ucywgc2V0dGluZ3MsIHBlcm1pc3Npb25zLCBldmVudHMgfTogUHJlZmV0Y2hPcHRpb25zKTogUHJvbWlzZTxQcmVmZXRjaFJlc3BvbnNlPiB7XG4gICAgbGV0IHBhcmFtc1RvU2VuZDogUHJlZmV0Y2hSZXF1ZXN0ID0ge1xuICAgICAgYXBpa2V5OiB0aGlzLnNlc3Npb24uYXBpa2V5LFxuICAgIH07XG5cbiAgICBpZiAodGhpcy5zZXNzaW9uLnBvbGljeSAmJiB0aGlzLnNlc3Npb24uc2lnbmF0dXJlKSB7XG4gICAgICBwYXJhbXNUb1NlbmQuc2VjdXJpdHkgPSB7IHBvbGljeTogdGhpcy5zZXNzaW9uLnBvbGljeSwgc2lnbmF0dXJlOiB0aGlzLnNlc3Npb24uc2lnbmF0dXJlIH07XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc2Vzc2lvbi5wcmVmZXRjaCAmJiBldmVudHMpIHtcbiAgICAgIHJldHVybiBGc1JlcXVlc3QucG9zdChgJHt0aGlzLnNlc3Npb24udXJscy51cGxvYWRBcGlVcmx9L3ByZWZldGNoYCwgeyAuLi5wYXJhbXNUb1NlbmQsIGV2ZW50cyB9KS50aGVuKCgpID0+IHRoaXMuc2Vzc2lvbi5wcmVmZXRjaCk7XG4gICAgfVxuXG4gICAgLy8gd2Ugc2hvdWxkIGFsd2F5cyBhc2sgZm9yIHRoaXMgc2V0dGluZyBmb3IgcGlja2VyXG4gICAgaWYgKCFzZXR0aW5ncykge1xuICAgICAgc2V0dGluZ3MgPSBbJ2luYXBwX2Jyb3dzZXInXTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2V0dGluZ3MgPSBzZXR0aW5ncy5jb25jYXQoWydpbmFwcF9icm93c2VyJ10pO1xuICAgICAgLy8gbWFrZSBhcnJyYXkgdW5pcXVlXG4gICAgICBzZXR0aW5ncyA9IHNldHRpbmdzLmZpbHRlcigodiwgaSwgYSkgPT4gc2V0dGluZ3MuaW5kZXhPZih2KSA9PT0gaSk7XG4gICAgfVxuXG4gICAgbGV0IHBpY2tlck9wdGlvbnNUb1NlbmQ7XG4gICAgaWYgKHBpY2tlck9wdGlvbnMgJiYgT2JqZWN0LmtleXMocGlja2VyT3B0aW9ucykubGVuZ3RoKSB7XG4gICAgICBwaWNrZXJPcHRpb25zVG9TZW5kID0gY2xlYW5VcENhbGxiYWNrcyh7IC4uLnBpY2tlck9wdGlvbnMgfSk7XG4gICAgfVxuXG4gICAgcGFyYW1zVG9TZW5kID0ge1xuICAgICAgLi4ucGFyYW1zVG9TZW5kLFxuICAgICAgcGVybWlzc2lvbnMsXG4gICAgICBzZXR0aW5ncyxcbiAgICAgIHBpY2tlcl9jb25maWc6IHBpY2tlck9wdGlvbnNUb1NlbmQsXG4gICAgICBldmVudHMsXG4gICAgfTtcblxuICAgIHRoaXMuc2Vzc2lvbi5wcmVmZXRjaCA9IG51bGw7XG5cbiAgICByZXR1cm4gRnNSZXF1ZXN0LnBvc3QoYCR7dGhpcy5zZXNzaW9uLnVybHMudXBsb2FkQXBpVXJsfS9wcmVmZXRjaGAsIHBhcmFtc1RvU2VuZCkudGhlbigocmVzKSA9PiB7XG4gICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi9cbiAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEZpbGVzdGFja0Vycm9yKCdUaGVyZSBpcyBhIHByb2JsZW0gd2l0aCBwcmVmZXRjaCByZXF1ZXN0Jyk7XG4gICAgICB9XG5cbiAgICAgIGxldCBkYXRhID0gcmVzLmRhdGE7XG5cbiAgICAgIC8vIGlmIGJhY2tlbmQgbm90IHJldHVybmluZyB1cGRhdGVkX2NvbmZpZyBjYXkgd2UgdGFrZSBvbGQgY29uZmlnIGFuZCByZXR1cm5cbiAgICAgIGlmIChkYXRhLnVwZGF0ZWRfY29uZmlnKSB7XG4gICAgICAgIC8vIHJlYXNzaWduIGNhbGxiYWNrIGZyb20gb2xkIGNvbmZpZyB0byBuZXcgb25lIHJldHVybmVkIGZyb20gYmFja2VuZFxuICAgICAgICBkYXRhLnBpY2tlck9wdGlvbnMgPSB0aGlzLnJlYXNzaWduQ2FsbGJhY2tzKHBpY2tlck9wdGlvbnMsIGRhdGEudXBkYXRlZF9jb25maWcgfHwge30pO1xuICAgICAgICBkZWxldGUgZGF0YS51cGRhdGVkX2NvbmZpZztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEucGlja2VyT3B0aW9ucyA9IHBpY2tlck9wdGlvbnM7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2Vzc2lvbi5wcmVmZXRjaCA9IGRhdGE7XG5cbiAgICAgIHJldHVybiBkYXRhO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYXNzaWduIGNhbGxiYWNrcyBmcm9tIG9sZCBwaWNrZXIgY29uZmlndXJhdGlvblxuICAgKlxuICAgKiBAcGFyYW0gb2JqT2xkXG4gICAqIEBwYXJhbSBvYmpUYXJnZXRcbiAgICovXG4gIHByaXZhdGUgcmVhc3NpZ25DYWxsYmFja3Mob2JqT2xkLCBvYmpUYXJnZXQpIHtcbiAgICBpZiAoIW9iak9sZCB8fCBPYmplY3Qua2V5cyhvYmpPbGQpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG9iak9sZDtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGsgaW4gb2JqT2xkKSB7XG4gICAgICBpZiAodHlwZW9mIG9iak9sZFtrXSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBvYmpUYXJnZXRba10gPSBvYmpPbGRba107XG4gICAgICB9XG5cbiAgICAgIGlmIChvYmpPbGRba10gPT09IE9iamVjdChvYmpPbGRba10pKSB7XG4gICAgICAgIG9ialRhcmdldFtrXSA9IHRoaXMucmVhc3NpZ25DYWxsYmFja3Mob2JqT2xkW2tdLCBvYmpUYXJnZXRba10pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvYmpUYXJnZXQ7XG4gIH1cbn1cbiJdfQ==
